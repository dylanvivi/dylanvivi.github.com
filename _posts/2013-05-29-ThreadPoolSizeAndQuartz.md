---
layout: post
title: Quartz以及线程池大小设置
category: notes
---

不说不知道，总结一下真觉得一个项目里能学到的东西挺多的。可是我能做的还是太少了……T-T…… 

主要想说的是对上面那个消息服务进行压力测试的情况。其实我一直以为这件事情应该是测试童鞋做的，也没什么方法论的，于是……上周末自己开了一个客户端，while(true) 一下，一直给服务器发消息，看看服务器的反应如何。基本上测试数据是一条通知对7000条数据，客户端丢一个消息过去，服务器就转发7000次。设置了下班开始发，第二天早晨6点结束，也就是跑12个小时…… 

话说，走之前我那个小心脏跳的啊…… 从没有做过这样的事，也不知道后果会是啥。晚上睡觉都没睡好，做的梦都是 while(true) 了太多次，直接导致机器爆炸…… 然后第二天早晨6点多自己就醒了…… 阿门，原谅我这个土鳖的不懂编译原理的妹纸吧…… 

事实证明，对于不了解的东西瞎弄是一定会出问题的。这个压力测试果然把测试环境跑挂了。定时器Quartz拒绝添加任务，抛异常，然后就挂了。

其实在测试之前就知道线程池和队列的大小不会设计，会导致问题。大的线程池能提高对CPU的利用率，加快消费者消费，大的队列则可以加快任务的提交速度。然而大能大到多大，没有一个具体的量化的理论指导。

为了解决这个问题，看了Spring Quartz的源码，又了解了一下队列大小和内存之间的关系。

    占用内存 = 队列中对象大小（所有类型占用空间最大值） * 队列大小

例如对象 User 有两个字段，int id 和 String name。int占4个字节，name最大值为5的话，全中国字占10个字节，那么一个size为500的User队列，所占用的最大内存为：14 * 500 = 7000。约6k+。

队列大小可以量化以后，就可以根据部署环境的实际情况进行队列大小的设置了。



--EOF--